(function(){define(["jquery-private","knockout","genfile","gcviz-i18n","gcviz-func","gcviz-gisgraphic"],function(b,c,g,e,h,f){var a,d;a=function(l,i,k){var j=function(s,w){var x=this,y,u,t,o,p=e.getDict("%toolbardraw-dist"),v=e.getDict("%toolbardraw-area"),n=h.getElemValueVM(w,["map","map"],"js"),A=b("#"+w+"_holder_layers"),z=s.find(".gcviz-draw-line"),m=s.find(".gcviz-draw-text"),r=s.find(".gcviz-draw-length"),q=s.find(".gcviz-draw-area"),B=s.find(".gcviz-draw-delsel");x.tpBlack=e.getDict("%toolbardraw-tpcolorblack");x.tpRed=e.getDict("%toolbardraw-tpcolorred");x.tpGreen=e.getDict("%toolbardraw-tpcolorgreen");x.tpBlue=e.getDict("%toolbardraw-tpcolorblue");x.tpYellow=e.getDict("%toolbardraw-tpcoloryellow");x.tpWhite=e.getDict("%toolbardraw-tpcolorwhite");x.tpDraw=e.getDict("%toolbardraw-tpdraw");x.tpText=e.getDict("%toolbardraw-tptext");x.tpMeasureArea=e.getDict("%toolbardraw-tpmeasurearea");x.tpMeasureLength=e.getDict("%toolbardraw-tpmeasurelength");x.tpErase=e.getDict("%toolbardraw-tperase");x.tpEraseSel=e.getDict("%toolbardraw-tperasesel");x.tpUndo=e.getDict("%toolbardraw-tpundo");x.tpRedo=e.getDict("%toolbardraw-tpredo");x.tpImport=e.getDict("%toolbardraw-tpimport");x.tpExport=e.getDict("%toolbardraw-tpexport");x.lblTextTitle=e.getDict("%toolbardraw-inputbox-name");x.lblTextDesc=e.getDict("%toolbardraw-inputbox-label");x.lblTextInfo=e.getDict("%toolbardraw-insinputbox");x.isTextDialogOpen=c.observable();x.isText=c.observable(false);x.drawTextValue=c.observable("");x.selectedColor=c.observable();x.stackUndo=c.observableArray([]);x.stackRedo=c.observableArray([]);x.isGraphics=c.observable(false);x.graphic=new f.initialize(n,x.isGraphics,x.stackUndo,x.stackRedo,p,v);x.measureHolder=c.observableArray([]);x.measureType="";x.activeTool=c.observable("");x.mapid=w;x.WCAGTitle=e.getDict("%wcag-title");x.lblWCAGx=e.getDict("%wcag-xlong");x.lblWCAGy=e.getDict("%wcag-ylat");x.lblWCAGmsgx=e.getDict("%wcag-msgx");x.lblWCAGmsgy=e.getDict("%wcag-msgy");x.tpWCAGadd=e.getDict("%wcag-addcoords");x.xValue=c.observable().extend({numeric:{precision:3,validation:{min:50,max:130}}});x.yValue=c.observable().extend({numeric:{precision:3,validation:{min:40,max:80}}});x.WCAGcoords=c.observableArray([]);x.isWCAG=c.observable(false);x.isDialogWCAG=c.observable(false);x.wcagok=false;x.init=function(){var C=b("#tbTools"+w+"_titleBarNode");C.on("click",x.endDraw);x.selectColorClick("black");return{controlsDescendantBindings:true}};x.endDraw=function(){x.removeCursors();A.css("cursor","default");if(x.measureType==="length"){u.remove();o.remove();x.endMeasureLength()}else{if(x.measureType==="area"){t.remove();o.remove();x.endMeasureArea()}}x.graphic.deactivate();x.measureType="";x.setFocus()};x.dialogTextOk=function(){var C=x.drawTextValue();if(C!==""){if(!x.isWCAG()){x.graphic.drawText(C,x.selectedColor())}else{x.isDialogWCAG(true)}x.isText(true);x.isTextDialogOpen(false)}else{x.dialogTextCancel()}};x.dialogTextOkEnter=function(){x.dialogTextOk()};x.dialogTextCancel=function(){x.isTextDialogOpen(false);x.isText(false);x.endDraw();x.openTools("text")};x.dialogTextClose=function(){if(x.isTextDialogOpen()){x.endDraw();x.openTools("text");x.isTextDialogOpen(false);x.isText(false)}};x.selectColorClick=function(C){x.selectedColor(C)};x.drawClick=function(){x.openTools("draw");if(!x.isWCAG()){A.css("cursor","");x.addDrawCursor(x.selectedColor());x.graphic.drawLine(x.selectedColor())}else{x.isDialogWCAG(true)}};x.textClick=function(){x.openTools("text");A.css("cursor","");A.addClass("gcviz-text-cursor");x.isText(false);x.drawTextValue("");x.isTextDialogOpen(true)};x.eraseClick=function(){x.graphic.erase();b(".ui-tooltip").remove()};x.eraseSelClick=function(){x.openTools("erase");A.css("cursor","");A.addClass("gcviz-draw-cursor-erase");x.graphic.drawExtent()};x.undoClick=function(){x.graphic.undo();b(".ui-tooltip").remove()};x.redoClick=function(){x.graphic.redo();b(".ui-tooltip").remove()};x.measureLengthClick=function(){y=h.getUUID();x.openTools("length");x.measureType="length";A.css("cursor","");A.addClass("gcviz-draw-cursor-measure");u=n.on("click",function(C){x.graphic.addMeasure(x.measureHolder,y,0,"km",x.selectedColor(),C)});o=n.on("dbl-click",function(C){x.graphic.addMeasure(x.measureHolder,y,0,"km",x.selectedColor(),C);setTimeout(function(){x.endMeasureLength()},250)})};x.endMeasureLength=function(){var C=x.measureHolder().length;if(C>=2){x.graphic.addMeasureSumLength(x.measureHolder,y,"km")}else{if(C>0){x.graphic.eraseUnfinish()}}x.measureHolder([]);y=h.getUUID()};x.measureAreaClick=function(){y=h.getUUID();x.openTools("area");x.measureType="area";A.css("cursor","");A.addClass("gcviz-draw-cursor-measure");t=n.on("click",function(C){x.graphic.addMeasure(x.measureHolder,y,1,"km",x.selectedColor(),C)});o=n.on("dbl-click",function(C){x.graphic.addMeasure(x.measureHolder,y,1,"km",x.selectedColor(),C);x.endMeasureArea()})};x.endMeasureArea=function(){var C=x.measureHolder().length;if(C>=3){x.graphic.addMeasureSumArea(x.measureHolder,y,"km")}else{if(C>0){x.graphic.eraseUnfinish()}}x.measureHolder([]);y=h.getUUID()};x.launchDialog=function(){b(document.getElementById("fileDialogAnno"))[0].click()};x.importClick=function(F,H){var E,D,G=H.target.files,C=G.length;while(C--){E=G[C];D=new FileReader();D.onload=x.loadFile();D.readAsText(E)}document.getElementById("fileDialogAnno").value=""};x.loadFile=function(){return function(E){var C;try{C=JSON.parse(E.target.result);f.importGraphics(n,C,x.isGraphics)}catch(D){console.log("Not able to load graphics: "+D)}}};x.exportClick=function(){var C=f.exportGraphics(n);b.generateFile({filename:"graphics.json",content:C,script:k.urldownload})};x.openTools=function(C){h.getElemValueVM(w,["header","toolsClick"],"js")();x.activeTool(C)};x.removeCursors=function(){A.removeClass("gcviz-draw-cursor-black gcviz-draw-cursor-blue gcviz-draw-cursor-green gcviz-draw-cursor-red gcviz-draw-cursor-yellow gcviz-draw-cursor-white gcviz-text-cursor gcviz-draw-cursor-measure gcviz-draw-cursor-erase")};x.addDrawCursor=function(C){if(C==="black"){A.addClass("gcviz-draw-cursor-black")}else{if(C==="blue"){A.addClass("gcviz-draw-cursor-blue")}else{if(C==="green"){A.addClass("gcviz-draw-cursor-green")}else{if(C==="red"){A.addClass("gcviz-draw-cursor-red")}else{if(C==="yellow"){A.addClass("gcviz-draw-cursor-yellow")}else{if(C==="white"){A.addClass("gcviz-draw-cursor-white")}}}}}}};x.setFocus=function(){setTimeout(function(){if(x.activeTool()==="draw"){z.focus()}else{if(x.activeTool()==="text"){m.focus()}else{if(x.activeTool()==="length"){r.focus()}else{if(x.activeTool()==="area"){q.focus()}else{if(x.activeTool()==="erase"){B.focus()}}}}}x.activeTool("")},500)};x.dialogWCAGOk=function(){var C=false;if(x.activeTool()==="draw"&&x.WCAGcoords().length>1){x.graphic.drawLineWCAG(x.WCAGcoords(),x.selectedColor());C=true}else{if(x.activeTool()==="text"){x.graphic.drawTextWCAG([x.xValue()*-1,x.yValue()],x.drawTextValue(),x.selectedColor());C=true}}if(C){x.isDialogWCAG(false);x.wcagok=true}};x.dialogWCAGCancel=function(){x.isDialogWCAG(false)};x.dialogWCAGClose=function(){x.isDialogWCAG(false);if(!x.wcagok){x.openTools(x.activeTool());x.setFocus()}x.wcagok=false;x.WCAGcoords([])};x.addCoords=function(){var C=x.xValue()*-1,E=x.yValue(),D=x.WCAGcoords()[x.WCAGcoords().length-1];if(typeof D==="undefined"){x.WCAGcoords.push([C,E])}else{if(C!==D[0]||E!==D[1]){x.WCAGcoords.push([C,E])}}};x.init()};d=new j(l,i);c.applyBindings(d,l[0]);return d};return{initialize:a}})}).call(this);